<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>London Culture ‚Äî Equipment Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #0f0f0f;
    --paper: #f5f2eb;
    --card: #ffffff;
    --accent: #c8410a;
    --accent-light: #f4ede6;
    --accent2: #1a6b4a;
    --accent2-light: #e6f2ec;
    --muted: #7a7570;
    --border: #e2ddd6;
    --success: #1a6b4a;
    --shadow: 0 2px 16px rgba(15,15,15,0.08);
    --shadow-lg: 0 8px 40px rgba(15,15,15,0.14);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--paper); color: var(--ink); min-height: 100vh; font-size: 15px; line-height: 1.6; }
  header { background: var(--ink); color: var(--paper); padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 64px; position: sticky; top: 0; z-index: 100; border-bottom: 3px solid var(--accent); }
  .logo { font-family: 'DM Serif Display', serif; font-size: 1.25rem; letter-spacing: -0.01em; }
  .logo span { color: var(--accent); font-style: italic; }
  nav { display: flex; gap: 0.25rem; }
  nav button { background: none; border: 1px solid transparent; color: #a09a93; padding: 0.4rem 1rem; border-radius: 4px; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase; transition: all 0.2s; }
  nav button:hover { color: var(--paper); border-color: #3a3530; }
  nav button.active { color: var(--paper); background: var(--accent); border-color: var(--accent); }
  .page { display: none; padding: 2.5rem 2rem; max-width: 680px; margin: 0 auto; }
  .page.active { display: block; animation: fadeUp 0.3s ease; }
  .page-wide { max-width: 960px; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .page-header { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
  .page-header h1 { font-family: 'DM Serif Display', serif; font-size: 2rem; font-weight: 400; letter-spacing: -0.02em; }
  .page-header p { color: var(--muted); margin-top: 0.35rem; font-size: 0.9rem; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1.25rem; }
  .card-title { font-family: 'DM Mono', monospace; font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
  .card-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .form-group { margin-bottom: 1.25rem; }
  label { display: block; font-size: 0.82rem; font-weight: 500; margin-bottom: 0.4rem; color: var(--ink); }
  label .req { color: var(--accent); margin-left: 2px; }
  input, select, textarea { width: 100%; padding: 0.65rem 0.9rem; border: 1px solid var(--border); border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; background: #faf9f7; color: var(--ink); transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(200,65,10,0.1); background: #fff; }
  textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .hint { font-size: 0.78rem; color: var(--muted); margin-top: 0.3rem; }
  .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.7rem 1.4rem; border-radius: 6px; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 500; transition: all 0.2s; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #a83308; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(200,65,10,0.3); }
  .btn-secondary { background: var(--ink); color: var(--paper); }
  .btn-secondary:hover { background: #2a2520; }
  .btn-ghost { background: transparent; color: var(--ink); border: 1px solid var(--border); }
  .btn-ghost:hover { background: var(--paper); }
  .btn-success { background: var(--success); color: #fff; }
  .btn-success:hover { background: #135438; }
  .btn-danger { background: #c0392b; color: #fff; }
  .btn-danger:hover { background: #a93226; }
  .btn-sm { padding: 0.4rem 0.85rem; font-size: 0.8rem; }
  .btn-full { width: 100%; justify-content: center; padding: 0.85rem; }
  .badge { display: inline-flex; align-items: center; padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.72rem; font-weight: 500; font-family: 'DM Mono', monospace; letter-spacing: 0.04em; }
  .badge-available { background: var(--accent2-light); color: var(--accent2); }
  .badge-checked-out { background: #fdecea; color: #c0392b; }
  .badge-pending { background: #fef9e7; color: #b7950b; }
  .badge-overdue { background: #fdedec; color: #c0392b; border: 1px solid #e74c3c; }
  .steps { display: flex; margin-bottom: 2rem; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--card); }
  .step { flex: 1; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.75rem; color: var(--muted); border-right: 1px solid var(--border); transition: all 0.2s; }
  .step:last-child { border-right: none; }
  .step.active { background: var(--accent); color: #fff; font-weight: 600; }
  .step.done { background: var(--accent-light); color: var(--accent); }
  .step-num { font-family: 'DM Mono', monospace; font-size: 0.62rem; display: block; opacity: 0.7; margin-bottom: 0.1rem; }
  .checkout-step { display: none; }
  .checkout-step.active { display: block; animation: fadeUp 0.25s ease; }
  .event-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; margin-bottom: 1.5rem; }
  .event-card { border: 2px solid var(--border); border-radius: 10px; padding: 1.25rem; cursor: pointer; transition: all 0.2s; background: var(--card); text-align: center; }
  .event-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
  .event-card.selected { border-color: var(--accent); background: var(--accent-light); }
  .event-card .icon { font-size: 1.75rem; margin-bottom: 0.5rem; }
  .event-card .label { font-weight: 600; font-size: 0.9rem; }
  .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
  .cat-card { border: 2px solid var(--border); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s; background: var(--card); display: flex; align-items: center; gap: 0.75rem; }
  .cat-card:hover { border-color: var(--accent); }
  .cat-card.selected { border-color: var(--accent); background: var(--accent-light); }
  .cat-card.suggested { border-color: var(--accent2); background: var(--accent2-light); }
  .cat-card.selected.suggested { border-color: var(--accent); background: var(--accent-light); }
  .cat-icon { font-size: 1.4rem; flex-shrink: 0; }
  .cat-label { font-weight: 500; font-size: 0.88rem; }
  .cat-check { margin-left: auto; width: 20px; height: 20px; border-radius: 50%; border: 1.5px solid var(--border); background: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: transparent; transition: all 0.2s; flex-shrink: 0; }
  .cat-card.selected .cat-check { background: var(--accent); border-color: var(--accent); color: #fff; }
  .suggest-tag { font-family: 'DM Mono', monospace; font-size: 0.6rem; letter-spacing: 0.05em; text-transform: uppercase; color: var(--accent2); display: block; margin-top: 0.15rem; }
  .qty-list { display: flex; flex-direction: column; gap: 0.85rem; }
  .qty-row { display: flex; align-items: center; gap: 1rem; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 0.85rem 1rem; }
  .qty-icon { font-size: 1.25rem; flex-shrink: 0; }
  .qty-label { flex: 1; font-weight: 500; font-size: 0.9rem; }
  .qty-controls { display: flex; align-items: center; gap: 0.5rem; }
  .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: 1.5px solid var(--border); background: var(--paper); cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--ink); }
  .qty-btn:hover { border-color: var(--accent); color: var(--accent); }
  .qty-num { font-family: 'DM Mono', monospace; font-size: 1rem; font-weight: 500; min-width: 28px; text-align: center; }
  .review-item { display: flex; justify-content: space-between; align-items: baseline; padding: 0.6rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
  .review-item:last-child { border-bottom: none; }
  .review-label { color: var(--muted); font-size: 0.8rem; }
  .review-value { font-weight: 500; }
  .success-state { text-align: center; padding: 3rem 2rem; }
  .success-icon { width: 64px; height: 64px; border-radius: 50%; background: var(--accent2-light); color: var(--accent2); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; margin: 0 auto 1.25rem; }
  .success-state h2 { font-family: 'DM Serif Display', serif; font-size: 1.75rem; margin-bottom: 0.5rem; }
  .success-state p { color: var(--muted); max-width: 380px; margin: 0 auto; }
  .notice { border-radius: 6px; padding: 0.75rem 1rem; font-size: 0.84rem; margin-bottom: 1rem; display: flex; align-items: flex-start; gap: 0.6rem; }
  .notice-info { background: #ebf5fb; border: 1px solid #aed6f1; color: #1a5276; }
  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
  .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; text-align: center; }
  .stat-num { font-family: 'DM Serif Display', serif; font-size: 2.2rem; color: var(--ink); line-height: 1; }
  .stat-label { font-family: 'DM Mono', monospace; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-top: 0.3rem; }
  .stat-card.accent .stat-num { color: var(--accent); }
  .stat-card.success .stat-num { color: var(--success); }
  .stat-card.warn .stat-num { color: #b7950b; }
  .data-table { width: 100%; border-collapse: collapse; font-size: 0.84rem; }
  .data-table th { text-align: left; padding: 0.6rem 1rem; font-family: 'DM Mono', monospace; font-size: 0.68rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid var(--border); background: #faf9f7; }
  .data-table td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .data-table tr:hover td { background: #faf9f7; }
  .data-table tr:last-child td { border-bottom: none; }
  .items-list span { display: inline-block; background: #f0ede8; border-radius: 3px; padding: 0.1rem 0.4rem; margin: 0.1rem; font-family: 'DM Mono', monospace; font-size: 0.7rem; }
  .admin-login { max-width: 400px; margin: 4rem auto; }
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15,15,15,0.6); z-index: 200; align-items: center; justify-content: center; padding: 1rem; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--card); border-radius: 12px; padding: 2rem; max-width: 500px; width: 100%; box-shadow: var(--shadow-lg); animation: fadeUp 0.2s ease; }
  .modal h3 { font-family: 'DM Serif Display', serif; font-size: 1.4rem; margin-bottom: 0.5rem; }
  .modal p { color: var(--muted); font-size: 0.88rem; margin-bottom: 1.5rem; }
  .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
  .section-label { font-family: 'DM Mono', monospace; font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; margin-top: 1.25rem; }
  @media (max-width: 640px) {
    header { padding: 0 1rem; } .logo { font-size: 1rem; }
    nav button { padding: 0.35rem 0.6rem; font-size: 0.65rem; }
    .page { padding: 1.5rem 1rem; }
    .form-row, .event-grid, .cat-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">London <span>Culture</span> ‚Äî Equipment</div>
  <nav>
    <button class="active" onclick="showPage('checkout', this)">Request</button>
    <button onclick="showPage('admin', this)">Admin</button>
  </nav>
</header>

<!-- CHECKOUT PAGE -->
<div id="page-checkout" class="page active">
  <div class="page-header">
    <h1>Request Equipment</h1>
    <p>Tell us what you need and we'll get back to you.</p>
  </div>

  <div class="steps">
    <div class="step active" id="step-ind-1"><span class="step-num">01</span>You</div>
    <div class="step" id="step-ind-2"><span class="step-num">02</span>Event</div>
    <div class="step" id="step-ind-3"><span class="step-num">03</span>Equipment</div>
    <div class="step" id="step-ind-4"><span class="step-num">04</span>Quantities</div>
    <div class="step" id="step-ind-5"><span class="step-num">05</span>Confirm</div>
  </div>

  <!-- STEP 1 -->
  <div class="checkout-step active" id="checkout-step-1">
    <div class="card">
      <div class="card-title">Your Details</div>
      <div class="form-row">
        <div class="form-group">
          <label>Full Name <span class="req">*</span></label>
          <input type="text" id="req-name" placeholder="e.g. John Smith">
        </div>
        <div class="form-group">
          <label>Telegram Username <span class="req">*</span></label>
          <input type="text" id="req-telegram" placeholder="@yourusername">
          <div class="hint">So we can send you updates directly</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Email Address <span class="req">*</span></label>
          <input type="email" id="req-email" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="req-phone" placeholder="+44 7700 000000">
        </div>
      </div>
      <div class="form-group">
        <label>Are you part of the London Culture team? <span class="req">*</span></label>
        <select id="req-internal">
          <option value="">Select...</option>
          <option value="internal">Yes ‚Äî Internal team member</option>
          <option value="external">No ‚Äî External borrower</option>
        </select>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;">
      <button class="btn btn-primary" onclick="nextStep(1)">Continue ‚Üí</button>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="checkout-step" id="checkout-step-2">
    <div class="card">
      <div class="card-title">What's the occasion?</div>
      <div class="event-grid">
        <div class="event-card" onclick="selectEvent('worship', this)"><div class="icon">üéµ</div><div class="label">Worship Night</div></div>
        <div class="event-card" onclick="selectEvent('prayer', this)"><div class="icon">üôè</div><div class="label">Prayer Meeting</div></div>
        <div class="event-card" onclick="selectEvent('youth', this)"><div class="icon">‚ö°</div><div class="label">Youth Event</div></div>
        <div class="event-card" onclick="selectEvent('mens-womens', this)"><div class="icon">üë•</div><div class="label">Men's / Women's Group</div></div>
        <div class="event-card" onclick="selectEvent('other', this)" style="grid-column:span 2;"><div class="icon">üìã</div><div class="label">Other</div></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Event Name <span class="req">*</span></label>
          <input type="text" id="req-event-name" placeholder="e.g. Friday Night Worship">
        </div>
        <div class="form-group">
          <label>Venue / Location</label>
          <input type="text" id="req-venue" placeholder="e.g. Education Hall">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Event Date</label>
          <input type="date" id="req-event-date">
        </div>
        <div class="form-group">
          <label>Approx. Attendance</label>
          <select id="req-attendance">
            <option value="">Select range...</option>
            <option value="1-20">1‚Äì20 people</option>
            <option value="20-50">20‚Äì50 people</option>
            <option value="50-100">50‚Äì100 people</option>
            <option value="100+">100+ people</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Collection Date <span class="req">*</span></label>
          <input type="date" id="req-collect-date">
        </div>
        <div class="form-group">
          <label>Return Date <span class="req">*</span></label>
          <input type="date" id="req-return-date">
        </div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;">
      <button class="btn btn-ghost" onclick="prevStep(2)">‚Üê Back</button>
      <button class="btn btn-primary" onclick="nextStep(2)">Continue ‚Üí</button>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="checkout-step" id="checkout-step-3">
    <div class="card">
      <div class="card-title">What do you need?</div>
      <p style="font-size:0.88rem;color:var(--muted);margin-bottom:1.25rem;">Select the categories of equipment you need. Items in green are typically used for your event type.</p>
      <div class="cat-grid" id="cat-grid"></div>
    </div>
    <div style="display:flex;justify-content:space-between;">
      <button class="btn btn-ghost" onclick="prevStep(3)">‚Üê Back</button>
      <button class="btn btn-primary" onclick="nextStep(3)">Continue ‚Üí</button>
    </div>
  </div>

  <!-- STEP 4 -->
  <div class="checkout-step" id="checkout-step-4">
    <div class="card">
      <div class="card-title">How many do you need?</div>
      <p style="font-size:0.88rem;color:var(--muted);margin-bottom:1.25rem;">We'll assign specific items when your request is approved.</p>
      <div class="qty-list" id="qty-list"></div>
    </div>
    <div class="form-group">
      <label>Any notes for the media team?</label>
      <textarea id="req-notes" placeholder="e.g. need mic stands, event is outdoors..."></textarea>
    </div>
    <div style="display:flex;justify-content:space-between;">
      <button class="btn btn-ghost" onclick="prevStep(4)">‚Üê Back</button>
      <button class="btn btn-primary" onclick="nextStep(4)">Review Request ‚Üí</button>
    </div>
  </div>

  <!-- STEP 5 -->
  <div class="checkout-step" id="checkout-step-5">
    <div class="card">
      <div class="card-title">Review Your Request</div>
      <div id="review-content"></div>
    </div>
    <div class="notice notice-info">‚ÑπÔ∏è Your request will be sent to the media team for approval. You'll be notified via Telegram once reviewed.</div>
    <div style="display:flex;justify-content:space-between;">
      <button class="btn btn-ghost" onclick="prevStep(5)">‚Üê Back</button>
      <button class="btn btn-primary" onclick="submitRequest()" id="submit-btn">Submit Request ‚ú¶</button>
    </div>
  </div>

  <!-- SUCCESS -->
  <div class="checkout-step" id="checkout-step-success">
    <div class="success-state">
      <div class="success-icon">‚úì</div>
      <h2>Request Submitted!</h2>
      <p>The media team has been notified and will review your request shortly. Keep an eye on Telegram!</p>
      <div style="margin-top:1.5rem;">
        <button class="btn btn-secondary" onclick="resetForm()">Make Another Request</button>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="page-admin" class="page page-wide">
  <div id="admin-login-gate">
    <div class="admin-login">
      <div class="page-header"><h1>Admin Access</h1><p>Media team only.</p></div>
      <div class="card">
        <div class="form-group">
          <label>Admin Password</label>
          <input type="password" id="admin-password" placeholder="Enter password" onkeyup="if(event.key==='Enter') adminLogin()">
        </div>
        <button class="btn btn-secondary btn-full" onclick="adminLogin()">Sign In</button>
      </div>
    </div>
  </div>

  <div id="admin-dashboard" style="display:none;">
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
      <div><h1>Admin Dashboard</h1><p>Manage requests, checkouts and returns.</p></div>
      <button class="btn btn-ghost btn-sm" onclick="adminLogout()">Sign Out</button>
    </div>
    <div class="stats-row">
      <div class="stat-card warn"><div class="stat-num" id="stat-pending">0</div><div class="stat-label">Pending</div></div>
      <div class="stat-card accent"><div class="stat-num" id="stat-active">0</div><div class="stat-label">Checked Out</div></div>
      <div class="stat-card"><div class="stat-num" id="stat-overdue">0</div><div class="stat-label">Overdue</div></div>
      <div class="stat-card success"><div class="stat-num" id="stat-available">0</div><div class="stat-label">Available</div></div>
    </div>
    <div class="card-title" style="margin-bottom:0.75rem;">Pending Requests</div>
    <div class="card" style="padding:0;overflow:hidden;margin-bottom:1.5rem;">
      <table class="data-table">
        <thead><tr><th>Requestor</th><th>Event</th><th>Equipment Needed</th><th>Dates</th><th>Type</th><th>Actions</th></tr></thead>
        <tbody id="pending-tbody"></tbody>
      </table>
    </div>
    <div class="card-title" style="margin-bottom:0.75rem;">Active Checkouts</div>
    <div class="card" style="padding:0;overflow:hidden;">
      <table class="data-table">
        <thead><tr><th>Borrower</th><th>Items Out</th><th>Checked Out</th><th>Due Back</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="active-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" id="approve-modal">
  <div class="modal">
    <h3 id="modal-title">Approve Request</h3>
    <p id="modal-body"></p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" id="modal-confirm-btn" onclick="confirmApprove()">Approve</button>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwA86mqargcUKG4wtxPFtFRH8th8aDalxHAnzyo5gVryxK5umZvnGzJviLhtMJZ6D_p0g/exec',
  SHEET_ID: '1FWY-jAJVXtl13SwZ590VwyKq5cV6jnv6fTSoRfVZW-w',
  ADMIN_PASSWORD: 'mediaadmin2024',
};

const CATEGORIES = [
  { id: 'wireless-mics',  label: 'Wireless Mics',         icon: 'üé§' },
  { id: 'earset-mics',    label: 'Earset / Headset Mics',  icon: 'üéß' },
  { id: 'speakers',       label: 'Speakers',               icon: 'üîä' },
  { id: 'mixer',          label: 'Mixer / Sound Desk',     icon: 'üéöÔ∏è' },
  { id: 'lighting',       label: 'Lighting',               icon: 'üí°' },
  { id: 'camcorders',     label: 'Camcorders',             icon: 'üé•' },
  { id: 'cables',         label: 'Cables & Extensions',    icon: 'üîå' },
];

const SUGGESTIONS = {
  worship:       ['wireless-mics', 'speakers', 'mixer', 'lighting'],
  prayer:        ['wireless-mics', 'speakers', 'mixer', 'lighting'],
  youth:         ['wireless-mics', 'speakers', 'mixer', 'lighting'],
  'mens-womens': ['wireless-mics', 'speakers', 'mixer', 'lighting'],
  other:         [],
};

const EVENT_LABELS = {
  worship: 'Worship Night', prayer: 'Prayer Meeting',
  youth: 'Youth Event', 'mens-womens': "Men's / Women's Group", other: 'Other',
};

let selectedEventType = '';
let selectedCategories = new Set();
let quantities = {};
let pendingRequests = [];
let activeCheckouts = [];
let currentAction = null;
let availableCounts = {};

document.addEventListener('DOMContentLoaded', async () => {
  const today = new Date().toISOString().split('T')[0];
  ['req-collect-date','req-return-date','req-event-date'].forEach(id => document.getElementById(id).min = today);
  await loadAvailableCounts();
});

async function loadAvailableCounts() {
  try {
    const res = await fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getEquipment' }) });
    const data = await res.json();
    if (data.success && data.items) {
      const subCatMap = {
        'Mics & Receivers': 'wireless-mics', 'Earset / Headset Mics': 'earset-mics',
        'Speakers & Amps': 'speakers', 'Mixers': 'mixer', 'LED Lights': 'lighting',
        'Camcorders': 'camcorders', 'Extensions': 'cables',
      };
      data.items.forEach(item => {
        const catId = subCatMap[item.subcategory];
        if (catId && item.status === 'available') availableCounts[catId] = (availableCounts[catId] || 0) + 1;
      });
    }
  } catch (e) { console.warn('Could not load availability:', e); }
}

function showPage(page, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (btn) btn.classList.add('active');
}

let currentStep = 1;

function nextStep(from) {
  if (!validateStep(from)) return;
  if (from === 2) renderCategoryGrid();
  if (from === 3) renderQuantityList();
  if (from === 4) buildReview();
  currentStep = from + 1;
  updateStepUI(currentStep);
}

function prevStep(from) {
  currentStep = from - 1;
  updateStepUI(currentStep);
}

function updateStepUI(step) {
  document.querySelectorAll('.checkout-step').forEach(s => s.classList.remove('active'));
  document.getElementById('checkout-step-' + step).classList.add('active');
  document.querySelectorAll('.step').forEach((s, i) => {
    s.classList.remove('active','done');
    if (i + 1 === step) s.classList.add('active');
    if (i + 1 < step) s.classList.add('done');
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep(step) {
  if (step === 1) {
    if (!document.getElementById('req-name').value.trim() ||
        !document.getElementById('req-telegram').value.trim() ||
        !document.getElementById('req-email').value.trim() ||
        !document.getElementById('req-internal').value) {
      alert('Please fill in all required fields.'); return false;
    }
  }
  if (step === 2) {
    if (!selectedEventType) { alert('Please select an event type.'); return false; }
    if (!document.getElementById('req-event-name').value.trim()) { alert('Please enter an event name.'); return false; }
    if (!document.getElementById('req-collect-date').value || !document.getElementById('req-return-date').value) { alert('Please enter collection and return dates.'); return false; }
    if (document.getElementById('req-return-date').value < document.getElementById('req-collect-date').value) { alert('Return date must be after collection date.'); return false; }
  }
  if (step === 3) { if (selectedCategories.size === 0) { alert('Please select at least one equipment category.'); return false; } }
  if (step === 4) {
    const hasQty = [...selectedCategories].some(c => (quantities[c] || 0) > 0);
    if (!hasQty) { alert('Please set a quantity for at least one item.'); return false; }
  }
  return true;
}

function selectEvent(type, el) {
  selectedEventType = type;
  document.querySelectorAll('.event-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

function renderCategoryGrid() {
  const suggested = SUGGESTIONS[selectedEventType] || [];
  document.getElementById('cat-grid').innerHTML = CATEGORIES.map(cat => {
    const isSuggested = suggested.includes(cat.id);
    const isSelected = selectedCategories.has(cat.id);
    const available = availableCounts[cat.id] || 0;
    const classes = ['cat-card', isSelected ? 'selected' : '', isSuggested && !isSelected ? 'suggested' : ''].filter(Boolean).join(' ');
    return `<div class="${classes}" onclick="toggleCat('${cat.id}', this)">
      <div class="cat-icon">${cat.icon}</div>
      <div>
        <div class="cat-label">${cat.label}</div>
        ${isSuggested && !isSelected ? '<span class="suggest-tag">‚ú¶ suggested</span>' : ''}
        <div style="font-size:0.72rem;color:${available > 0 ? 'var(--muted)' : '#c0392b'};margin-top:0.1rem;">${available > 0 ? available + ' available' : 'Check availability'}</div>
      </div>
      <div class="cat-check">‚úì</div>
    </div>`;
  }).join('');
}

function toggleCat(catId) {
  if (selectedCategories.has(catId)) { selectedCategories.delete(catId); quantities[catId] = 0; }
  else { selectedCategories.add(catId); if (!quantities[catId]) quantities[catId] = 1; }
  renderCategoryGrid();
}

function renderQuantityList() {
  const selected = CATEGORIES.filter(c => selectedCategories.has(c.id));
  document.getElementById('qty-list').innerHTML = selected.map(cat => {
    const qty = quantities[cat.id] || 1;
    quantities[cat.id] = qty;
    return `<div class="qty-row">
      <div class="qty-icon">${cat.icon}</div>
      <div class="qty-label">${cat.label}<div style="font-size:0.75rem;color:var(--muted);">${availableCounts[cat.id] || '?'} available</div></div>
      <div class="qty-controls">
        <button class="qty-btn" onclick="changeQty('${cat.id}', -1)">‚àí</button>
        <div class="qty-num" id="qty-${cat.id}">${qty}</div>
        <button class="qty-btn" onclick="changeQty('${cat.id}', 1)">+</button>
      </div>
    </div>`;
  }).join('');
}

function changeQty(catId, delta) {
  quantities[catId] = Math.max(1, (quantities[catId] || 1) + delta);
  const el = document.getElementById('qty-' + catId);
  if (el) el.textContent = quantities[catId];
}

function buildReview() {
  const get = id => document.getElementById(id).value;
  const equipment = CATEGORIES.filter(c => selectedCategories.has(c.id) && quantities[c.id] > 0)
    .map(c => `${c.icon} ${quantities[c.id]}√ó ${c.label}`).join('<br>');
  document.getElementById('review-content').innerHTML = `
    <div class="section-label">Requestor</div>
    <div class="review-item"><span class="review-label">Name</span><span class="review-value">${get('req-name')}</span></div>
    <div class="review-item"><span class="review-label">Telegram</span><span class="review-value">${get('req-telegram')}</span></div>
    <div class="review-item"><span class="review-label">Email</span><span class="review-value">${get('req-email')}</span></div>
    <div class="review-item"><span class="review-label">Team member?</span><span class="review-value">${get('req-internal') === 'internal' ? 'Yes ‚Äî Internal' : 'No ‚Äî External'}</span></div>
    <div class="section-label" style="margin-top:1.25rem;">Event</div>
    <div class="review-item"><span class="review-label">Event</span><span class="review-value">${get('req-event-name')}</span></div>
    <div class="review-item"><span class="review-label">Type</span><span class="review-value">${EVENT_LABELS[selectedEventType]}</span></div>
    ${get('req-venue') ? `<div class="review-item"><span class="review-label">Venue</span><span class="review-value">${get('req-venue')}</span></div>` : ''}
    ${get('req-event-date') ? `<div class="review-item"><span class="review-label">Date</span><span class="review-value">${formatDate(get('req-event-date'))}</span></div>` : ''}
    <div class="section-label" style="margin-top:1.25rem;">Dates</div>
    <div class="review-item"><span class="review-label">Collection</span><span class="review-value">${formatDate(get('req-collect-date'))}</span></div>
    <div class="review-item"><span class="review-label">Return</span><span class="review-value">${formatDate(get('req-return-date'))}</span></div>
    <div class="section-label" style="margin-top:1.25rem;">Equipment Requested</div>
    <div style="font-size:0.9rem;line-height:2.2;">${equipment}</div>
    ${get('req-notes') ? `<div class="section-label" style="margin-top:1.25rem;">Notes</div><div style="font-size:0.88rem;color:var(--muted);">${get('req-notes')}</div>` : ''}
  `;
}

async function submitRequest() {
  const btn = document.getElementById('submit-btn');
  btn.textContent = 'Sending...'; btn.disabled = true;
  const get = id => document.getElementById(id).value;
  const equipmentList = CATEGORIES.filter(c => selectedCategories.has(c.id) && quantities[c.id] > 0)
    .map(c => `${quantities[c.id]}x ${c.label}`).join(', ');
  try {
    await fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({
      action: 'newRequest', name: get('req-name'), telegram: get('req-telegram'),
      email: get('req-email'), phone: get('req-phone'), internal: get('req-internal'),
      eventType: selectedEventType, eventName: get('req-event-name'),
      eventDate: get('req-event-date'), venue: get('req-venue'),
      collectDate: get('req-collect-date'), returnDate: get('req-return-date'),
      attendance: get('req-attendance'), notes: get('req-notes'), items: equipmentList,
    })});
  } catch (e) { console.warn('Submit error:', e); }
  document.querySelectorAll('.checkout-step').forEach(s => s.classList.remove('active'));
  document.getElementById('checkout-step-success').classList.add('active');
  document.querySelectorAll('.step').forEach(s => s.classList.add('done'));
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function resetForm() {
  ['req-name','req-telegram','req-email','req-phone','req-event-name','req-venue','req-notes']
    .forEach(id => document.getElementById(id).value = '');
  ['req-internal','req-attendance','req-event-date','req-collect-date','req-return-date']
    .forEach(id => document.getElementById(id).value = '');
  selectedEventType = ''; selectedCategories.clear(); quantities = {}; currentStep = 1;
  updateStepUI(1);
  document.querySelectorAll('.event-card').forEach(c => c.classList.remove('selected'));
  btn = document.getElementById('submit-btn');
  btn.textContent = 'Submit Request ‚ú¶'; btn.disabled = false;
}

async function adminLogin() {
  if (document.getElementById('admin-password').value !== CONFIG.ADMIN_PASSWORD) { alert('Incorrect password.'); return; }
  document.getElementById('admin-login-gate').style.display = 'none';
  document.getElementById('admin-dashboard').style.display = 'block';
  await loadAdminData(); renderAdminDashboard();
}

function adminLogout() {
  document.getElementById('admin-login-gate').style.display = 'block';
  document.getElementById('admin-dashboard').style.display = 'none';
  document.getElementById('admin-password').value = '';
}

async function loadAdminData() {
  try {
    const [pr, ar] = await Promise.all([
      fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getPending', password: CONFIG.ADMIN_PASSWORD }) }),
      fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getActive', password: CONFIG.ADMIN_PASSWORD }) }),
    ]);
    const pd = await pr.json(); const ad = await ar.json();
    pendingRequests = pd.success ? pd.requests.map(r => ({
      id: r.requestId, name: r.name, telegram: r.telegram, event: r.eventName,
      eventType: r.eventType, items: Array.isArray(r.items) ? r.items.join(', ') : r.items,
      collectDate: r.collectDate, returnDate: r.returnDate, internal: r.internal, notes: r.notes,
    })) : [];
    activeCheckouts = ad.success ? ad.checkouts.map(c => ({
      id: c.checkoutId, name: c.name, telegram: c.telegram,
      items: Array.isArray(c.items) ? c.items.join(', ') : c.items,
      checkedOut: c.checkoutDate, dueBack: c.dueDate, overdue: c.overdue,
    })) : [];
  } catch (e) { console.warn('Admin data error:', e); }
}

function renderAdminDashboard() {
  document.getElementById('stat-pending').textContent = pendingRequests.length;
  document.getElementById('stat-active').textContent = activeCheckouts.length;
  document.getElementById('stat-overdue').textContent = activeCheckouts.filter(c => c.overdue).length;
  document.getElementById('stat-available').textContent = Object.values(availableCounts).reduce((a,b) => a+b, 0);

  document.getElementById('pending-tbody').innerHTML = pendingRequests.length === 0
    ? '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:2rem;">No pending requests.</td></tr>'
    : pendingRequests.map(req => `<tr>
        <td><strong>${req.name}</strong><div style="font-size:0.75rem;color:var(--muted);">${req.telegram}</div></td>
        <td>${req.event}<div style="font-size:0.75rem;color:var(--muted);">${EVENT_LABELS[req.eventType]||req.eventType}</div></td>
        <td class="items-list">${(req.items||'').split(', ').map(i=>`<span>${i}</span>`).join('')}</td>
        <td style="font-family:'DM Mono',monospace;font-size:0.78rem;">${formatDate(req.collectDate)}<br><span style="color:var(--muted);">‚Üí ${formatDate(req.returnDate)}</span></td>
        <td><span class="badge ${req.internal==='internal'?'badge-available':'badge-pending'}">${req.internal}</span></td>
        <td><div style="display:flex;gap:0.4rem;">
          <button class="btn btn-success btn-sm" onclick="openModal('${req.id}',true)">‚úì Approve</button>
          <button class="btn btn-danger btn-sm" onclick="openModal('${req.id}',false)">‚úï Reject</button>
        </div></td>
      </tr>`).join('');

  document.getElementById('active-tbody').innerHTML = activeCheckouts.length === 0
    ? '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:2rem;">No active checkouts.</td></tr>'
    : activeCheckouts.map(chk => `<tr>
        <td><strong>${chk.name}</strong><div style="font-size:0.75rem;color:var(--muted);">${chk.telegram}</div></td>
        <td class="items-list">${(chk.items||'').split(', ').map(i=>`<span>${i}</span>`).join('')}</td>
        <td style="font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--muted);">${formatDate(chk.checkedOut)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:0.78rem;${chk.overdue?'color:#c0392b;font-weight:600;':''}">${formatDate(chk.dueBack)}</td>
        <td>${chk.overdue?'<span class="badge badge-overdue">‚ö† Overdue</span>':'<span class="badge badge-checked-out">Out</span>'}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="markReturned('${chk.id}')">Mark Returned</button></td>
      </tr>`).join('');
}

function openModal(reqId, isApprove) {
  currentAction = { reqId, isApprove };
  const req = pendingRequests.find(r => r.id === reqId);
  document.getElementById('modal-title').textContent = isApprove ? 'Approve Request' : 'Reject Request';
  document.getElementById('modal-body').textContent = isApprove
    ? `Approve ${req?.name}'s request? They will be notified via Telegram.`
    : `Reject ${req?.name}'s request? They will be notified via Telegram.`;
  const btn = document.getElementById('modal-confirm-btn');
  btn.textContent = isApprove ? 'Approve' : 'Reject';
  btn.className = isApprove ? 'btn btn-success' : 'btn btn-danger';
  document.getElementById('approve-modal').classList.add('open');
}

function closeModal() { document.getElementById('approve-modal').classList.remove('open'); currentAction = null; }

async function confirmApprove() {
  if (!currentAction) return;
  const { reqId, isApprove } = currentAction;
  const btn = document.getElementById('modal-confirm-btn');
  btn.textContent = 'Processing...'; btn.disabled = true;
  try {
    await fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({
      action: isApprove ? 'approveRequest' : 'rejectRequest',
      requestId: reqId, password: CONFIG.ADMIN_PASSWORD,
      approvedBy: 'Media Team', rejectedBy: 'Media Team',
    })});
  } catch (e) { console.warn('Error:', e); }
  closeModal(); btn.disabled = false;
  await loadAdminData(); renderAdminDashboard();
}

async function markReturned(chkId) {
  try {
    await fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({
      action: 'markReturned', checkoutId: chkId, password: CONFIG.ADMIN_PASSWORD,
    })});
  } catch (e) { console.warn('Error:', e); }
  await loadAdminData(); renderAdminDashboard();
}

function formatDate(dateStr) {
  if (!dateStr) return '‚Äî';
  try {
    const parts = String(dateStr).split('T')[0].split('-');
    const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  } catch(e) { return dateStr; }
}
</script>
</body>
</html>
